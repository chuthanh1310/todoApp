@model List<testapp.Models.TodoViewModel>

@{
    ViewBag.Title = "Todo List";
    var completedCount = Model.Count(x => x.IsCompleted);
    var activeCount = Model.Count(x => !x.IsCompleted);
}

<h2>Todo List</h2>

<!-- Form tạo mới -->
@using (Html.BeginForm("Create", "Home", FormMethod.Post))
{
    <div>
        <input type="text" name="Title" placeholder="Nhập việc cần làm..." required />
        <input type="submit" value="Thêm" />
    </div>
}

<hr />

<!-- Danh sách todos -->
<ul id="todo-list" style="list-style: none; padding-left: 0;">
    @foreach (var todo in Model)
    {
        <li class="todo-item" data-id="@todo.Id" style="margin-bottom: 8px; position: relative;">
            <input type="checkbox" class="toggle-status" @(todo.IsCompleted ? "checked" : "") />
            <span style="@(todo.IsCompleted ? "text-decoration: line-through;" : "")">@todo.Title</span>

            <!-- Nút xóa chỉ hiện khi hover -->
            <form method="post" action="@Url.Action("Delete", "Home", new { id = todo.Id })" style="display: inline;">
                <button type="submit" class="delete-button" style="display: none; position: absolute; right: 0;">❌</button>
            </form>
        </li>
    }
</ul>

<hr />

<!-- Bộ đếm -->
<p>@activeCount công việc chưa hoàn thành</p>

<!-- Nút xóa tất cả mục hoàn thành -->
@if (completedCount > 0)
{
    <form method="post" action="@Url.Action("ClearCompleted", "Home")">
        <button type="submit">Xóa tất cả mục đã hoàn thành</button>
    </form>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Hover hiện nút xóa
        $(".todo-item").hover(
            function () {
                $(this).find(".delete-button").show();
            },
            function () {
                $(this).find(".delete-button").hide();
            }
        );

        // Checkbox cập nhật trạng thái qua Ajax
        $(".toggle-status").change(function () {
            const li = $(this).closest(".todo-item");
            const id = li.data("id");
            const isCompleted = $(this).is(":checked");

            $.ajax({
                url: '@Url.Action("ToggleStatus", "Home")',
                type: 'POST',
                data: { id: id, isCompleted: isCompleted },
                success: function () {
                    location.reload(); // reload lại trang để cập nhật UI
                }
            });
        });
    </script>
}
